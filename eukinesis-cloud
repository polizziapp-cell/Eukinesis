<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eukinesis Cloud</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .login-container h1 { color: #667eea; margin-bottom: 10px; }
        .google-btn {
            background: white;
            border: 2px solid #e9ecef;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 600;
            margin: 20px auto;
        }
        .google-btn:hover { border-color: #667eea; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 20px 0; display: none; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; overflow: hidden; display: none; }
        .container.active { display: block; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .logout-btn { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .tabs { display: flex; background: #f8f9fa; flex-wrap: wrap; }
        .tab { flex: 1; min-width: 100px; padding: 15px; text-align: center; border: none; background: none; font-size: 14px; font-weight: 600; color: #6c757d; cursor: pointer; }
        .tab.active { color: #667eea; background: white; border-bottom: 3px solid #667eea; }
        .content { padding: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; margin: 5px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; }
        .stat-card .value { font-size: 28px; font-weight: bold; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 5px; font-size: 14px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .loading { text-align: center; padding: 40px; }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <h1>üèÉ‚Äç‚ôÇÔ∏è Eukinesis</h1>
        <p>Gestionale Studio Chinesiologia</p>
        <button class="google-btn" onclick="loginWithGoogle()">
            <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg"><g fill="none"><path d="M17.6 9.2l-.1-1.8H9v3.4h4.8C13.6 12 13 13 12 13.6v2.2h3a8.8 8.8 0 0 0 2.6-6.6z" fill="#4285F4"/><path d="M9 18c2.4 0 4.5-.8 6-2.2l-3-2.2a5.4 5.4 0 0 1-8-2.9H1V13a9 9 0 0 0 8 5z" fill="#34A853"/><path d="M4 10.7a5.4 5.4 0 0 1 0-3.4V5H1a9 9 0 0 0 0 8l3-2.3z" fill="#FBBC05"/><path d="M9 3.6c1.3 0 2.5.4 3.4 1.3L15 2.3A9 9 0 0 0 1 5l3 2.4a5.4 5.4 0 0 1 5-3.7z" fill="#EA4335"/></g></svg>
            Accedi con Google
        </button>
        <div id="loginError" class="error"></div>
    </div>

    <div id="mainApp" class="container">
        <div class="header">
            <h1>üèÉ‚Äç‚ôÇÔ∏è Eukinesis</h1>
            <div>
                <span id="userEmail"></span>
                <button class="logout-btn" onclick="logout()">Esci</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="switchTab('clienti')">Clienti</button>
            <button class="tab" onclick="switchTab('admin')">Admin</button>
        </div>

        <div class="content">
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card"><h3>Clienti</h3><div class="value" id="totalClienti">0</div></div>
                </div>
                <div class="loading">Caricamento dati...</div>
            </div>

            <div id="clienti" class="tab-content">
                <button class="btn btn-primary" onclick="alert('Funzione in arrivo!')">+ Nuovo Cliente</button>
                <div id="listaClienti" class="loading">Caricamento...</div>
            </div>

            <div id="admin" class="tab-content">
                <h2>Gestione Utenti</h2>
                <div class="card">
                    <h3>Aggiungi Utente</h3>
                    <input type="email" id="newUserEmail" placeholder="email@gmail.com">
                    <button class="btn btn-success" onclick="aggiungiUtente()">Aggiungi</button>
                </div>
                <div id="listaUtenti" class="loading">Caricamento...</div>
            </div>
        </div>
    </div>

    <!-- Firebase compat version -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCshaj3_mPKZGsDoI3NYo5ptzNs10WpwXQ",
            authDomain: "eukinesis-2a3ca.firebaseapp.com",
            projectId: "eukinesis-2a3ca",
            storageBucket: "eukinesis-2a3ca.firebasestorage.app",
            messagingSenderId: "945062544752",
            appId: "1:945062544752:web:473141e7f1ab967f99fbb5"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let clienti = [];

        // Auth state
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('User logged in:', user.email);
                currentUser = user;
                
                // Check authorization
                try {
                    const doc = await db.collection('config').doc('authorized_users').get();
                    if (doc.exists && doc.data()[user.email] === true) {
                        console.log('User authorized!');
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainApp').classList.add('active');
                        document.getElementById('userEmail').textContent = user.email;
                        loadData();
                    } else {
                        console.log('User NOT authorized');
                        showError('Non sei autorizzato. Contatta l\'amministratore.');
                        auth.signOut();
                    }
                } catch (error) {
                    console.error('Authorization check error:', error);
                    showError('Errore verifica autorizzazione: ' + error.message);
                    auth.signOut();
                }
            } else {
                console.log('No user');
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('mainApp').classList.remove('active');
            }
        });

        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithRedirect(provider);
        }

        // Check redirect result
        auth.getRedirectResult().then((result) => {
            if (result.user) {
                console.log('Redirect login successful');
            }
        }).catch((error) => {
            console.error('Redirect error:', error);
            showError('Errore login: ' + error.message);
        });

        function logout() {
            auth.signOut();
        }

        function showError(msg) {
            const err = document.getElementById('loginError');
            err.textContent = msg;
            err.style.display = 'block';
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }

        async function loadData() {
            console.log('Loading data...');
            try {
                // Load clienti
                const snapshot = await db.collection('clienti').get();
                clienti = [];
                snapshot.forEach(doc => {
                    clienti.push({ id: doc.id, ...doc.data() });
                });
                
                document.getElementById('totalClienti').textContent = clienti.length;
                
                const html = clienti.length > 0 ? clienti.map(c => `
                    <div class="card">
                        <strong>${c.nome} ${c.cognome}</strong><br>
                        üìû ${c.telefono}
                    </div>
                `).join('') : '<p>Nessun cliente</p>';
                
                document.getElementById('listaClienti').innerHTML = html;
                
                // Load users
                loadUtenti();
            } catch (error) {
                console.error('Load data error:', error);
                alert('Errore caricamento: ' + error.message);
            }
        }

        async function loadUtenti() {
            try {
                const doc = await db.collection('config').doc('authorized_users').get();
                if (doc.exists()) {
                    const users = doc.data();
                    const html = Object.entries(users).map(([email, authorized]) => {
                        if (authorized) {
                            return `<div class="card">${email}</div>`;
                        }
                        return '';
                    }).join('');
                    document.getElementById('listaUtenti').innerHTML = html || '<p>Nessun utente</p>';
                }
            } catch (error) {
                console.error('Load users error:', error);
            }
        }

        async function aggiungiUtente() {
            const email = document.getElementById('newUserEmail').value.trim();
            if (!email) {
                alert('Inserisci un\'email');
                return;
            }
            
            try {
                await db.collection('config').doc('authorized_users').update({
                    [email]: true
                });
                document.getElementById('newUserEmail').value = '';
                loadUtenti();
                alert('‚úÖ Utente aggiunto!');
            } catch (error) {
                console.error('Add user error:', error);
                alert('Errore: ' + error.message);
            }
        }
    </script>
</body>
</html>
